<?php//Carga la clase de coneccion con sus metodos para consultas o transacciones//require("models/connection.php"); // funciones mySQL require("models/connection_sqli_manual.php"); // funciones mySQLiclass Reportes_ComprasModel extends Connection{        public function listaProveedores()    {        $myQuery = "SELECT idPrv,codigo,razon_social FROM mrp_proveedor ORDER BY idPrv";        return $this->query($myQuery);    }    public function listaSucursales()    {    	$myQuery = "SELECT idSuc, nombre FROM mrp_sucursal WHERE activo = -1";    	return $this->query($myQuery);    }    public function listaAlmacenes($idSuc)    {        $myQuery = "SELECT id, codigo_manual, nombre FROM app_almacenes WHERE id_sucursal = $idSuc ORDER BY codigo_sistema;";        return $this->query($myQuery);    }    public function listaFamilias($id_departamento)    {        $myQuery = "SELECT id, nombre FROM app_familia WHERE id_departamento = $id_departamento ORDER BY id;";        return $this->query($myQuery);    }    public function listaLineas($id_familia)    {        $myQuery = "SELECT id, nombre FROM app_linea WHERE id_familia = $id_familia ORDER BY id;";        return $this->query($myQuery);    }    public function listaUsuarios()    {    	$myQuery = "SELECT idEmpleado, CONCAT('(',codigo,') ', nombreEmpleado,' ',apellidoPaterno) AS Usuario FROM nomi_empleados WHERE activo = -1";    	return $this->query($myQuery);    }    public function listaProductos()    {    	$myQuery = "SELECT id, CONCAT('(',codigo,') ',nombre) AS Producto FROM app_productos WHERE status = 1";    	return $this->query($myQuery);    }    public function listaDepartamentos()    {    	$myQuery = "SELECT id, nombre FROM app_departamento";    	return $this->query($myQuery);    }    public function listaUnidadesBase()    {    	$myQuery = "SELECT id, clave, nombre FROM app_unidades_medida WHERE activo = 1";    	return $this->query($myQuery);    }    public function listaCaracteristicas()    {        $myQuery = "SELECT id, nombre FROM app_caracteristicas_padre ORDER BY id";        return $this->query($myQuery);    }    public function listaCaracteristicasHija($id_padre)    {        $myQuery = "SELECT id, nombre FROM app_caracteristicas_hija WHERE id_caracteristica_padre =  $id_padre ORDER BY id";        return $this->query($myQuery);    }    public function listaMedida($id_base)    {        $myQuery = "SELECT id, clave, nombre FROM app_unidades_medida WHERE id = $id_base || unidad_base = $id_base";        return $this->query($myQuery);    }    public function reforteGrafico($desde,$hasta,$ordenar,$radio)    {        if($radio==1){            if($ordenar==1){                $myQuery = "SELECT b.nombre,  sum(a.cantidad) as total from app_inventario_movimientos a    inner join app_productos b on b.id=a.id_producto    where tipo_traspaso=1 and referencia like 'Orden de compra%'    and a.fecha between '".$desde."' and '".$hasta."'    group by id_producto    order by sum(a.cantidad) desc limit 5";            }            if($ordenar==2){                $myQuery = "SELECT b.nombre,  sum(a.cantidad) as total from app_inventario_movimientos a    inner join app_productos b on b.id=a.id_producto    where tipo_traspaso=1 and referencia like 'Orden de compra%'    and a.fecha between '".$desde."' and '".$hasta."'    group by id_producto    order by sum(a.cantidad) asc limit 5";            }        }        if($radio==2){            if($ordenar==1){                $myQuery = "SELECT b.nombre,  sum(a.importe) as total from app_inventario_movimientos a    inner join app_productos b on b.id=a.id_producto    where tipo_traspaso=1 and referencia like 'Orden de compra%'    and a.fecha between '".$desde."' and '".$hasta."'    group by id_producto    order by sum(a.importe) desc limit 5";            }            if($ordenar==2){                $myQuery = "SELECT b.nombre,  sum(a.importe) as total from app_inventario_movimientos a    inner join app_productos b on b.id=a.id_producto    where tipo_traspaso=1 and referencia like 'Orden de compra%'    and a.fecha between '".$desde."' and '".$hasta."'    group by id_producto    order by sum(a.importe) asc limit 5";            }        }        return $this->query($myQuery);    }    public function prov_prod_reporte($vars)    {        $idPrvs = $vars['idPrvs'];        $proveedores = "";        if(intval($vars['rango']))            $proveedores .= " AND co.id_proveedor BETWEEN ".$idPrvs[0]." AND ".$idPrvs[1];        else        {            if($idPrvs[0])            {                $proveedores .= " AND (";                for($i=0;$i<=count($idPrvs)-1;$i++)                {                    if($i>0)                        $proveedores .= " OR ";                    $proveedores .= " co.id_proveedor = ".$idPrvs[$i];                }                $proveedores .= ") ";            }           }        $almacenes='';        if(intval($vars['sucursal']))        {            $almacenes = "AND a.id_sucursal = ".$vars['sucursal'];            if(intval($vars['almacen']))                   $almacenes = "AND co.id_almacen = ".$vars['almacen'];        }        $usuario = '';        if(intval($vars['usuario']))            $usuario = "AND co.id_usrcompra = ".$vars['usuario'];        $caracteristicas = '';        if(intval($vars['tipo_producto']) == 1)        {            if(intval($vars['departamento']))                $caracteristicas .= " AND pr.departamento = ".$vars['departamento'];            if(intval($vars['familia']))                $caracteristicas .= " AND pr.familia = ".$vars['familia'];            if(intval($vars['linea']))                $caracteristicas .= " AND pr.linea = ".$vars['linea'];        }        if(intval($vars['tipo_producto']) == 2)        {            if(intval($vars['caracteristica_padre']))                $caracteristicas .= " AND cd.caracteristica LIKE '%".$vars['caracteristica_padre']."=>%'";            if(intval($vars['caracteristica_hija1']))            {                $caracteristicas .= " AND (";                for($k = $vars['caracteristica_hija1']; $k <= $vars['caracteristica_hija2']; $k++)                {                    if($k > intval($vars['caracteristica_hija1']))                        $caracteristicas .= " OR ";                    $caracteristicas .= " cd.caracteristica LIKE '%=>$k%' ";                }                $caracteristicas .= " ) ";            }        }        $unidad_base = '';        if(intval($vars['unidad_base']))            $unidad_base = "AND id_unidad_compra = ".$vars['unidad_base'];         $factor = "pr.id_unidad_compra";        if(intval($vars['unidad_base_conversion']))        {            $factor = $vars['unidad_base_conversion'];        }        $producto = '';        if(intval($vars['producto']))            $producto = " AND cd.id_producto = ".$vars['producto'];                $recepcion = "";        $fecha = "co.fecha";        $activo = "co.activo";        $idc = "co.id AS id_compra,";        if(intval($vars['tipo_doc']) == 2)        {            $recepcion = "RIGHT JOIN app_recepcion re ON re.id_oc = co.id";            $fecha = "re.fecha_recepcion";            $activo = "re.activo";            $idc = "re.id AS id_compra,";        }        if(intval($vars['status_doc']) == 1)            $vars['status_doc'] = "1 OR ".$activo." = 4 OR ".$activo." = 5";        if(intval($vars['status_doc']) == 0)            $vars['status_doc'] = 3;        $myQuery = "SELECT cd.caracteristica,co.id_proveedor,(SELECT razon_social FROM mrp_proveedor WHERE idPrv = co.id_proveedor) Proveedor,pr.id_tipo_costeo,cd.id_producto,CONCAT('(',pr.codigo,') ',pr.nombre) AS Producto,$fecha AS fecha, $idc cd.cantidad AS cantidad,(SELECT CONCAT(nombre,'*|*',factor) FROM app_unidades_medida WHERE id = $factor) AS UnidadBase,cd.costo, (cd.costo*cd.cantidad) AS Importe, cd.impuestos FROM app_ocompra_datos cd INNER JOIN app_ocompra co ON co.id = cd.id_ocompraLEFT JOIN app_productos pr ON  pr.id = cd.id_productoLEFT JOIN app_almacenes a ON a.id = co.id_almacen$recepcion WHERE $fecha BETWEEN '".$vars['f_ini']."' AND '".$vars['f_fin']."' $producto $proveedores $almacenes $usuario $caracteristicas $unidad_base AND pr.id_moneda = ".$vars['moneda']." AND ($activo = ".$vars['status_doc'].") ORDER BY co.id_proveedor, cd.id_producto, $fecha";return $this->query($myQuery);    }    public function prov_prod_reporte_req($vars)    {        $idPrvs = $vars['idPrvs'];        $proveedores = "";        if(intval($vars['rango']))            $proveedores .= " AND re.id_proveedor BETWEEN ".$idPrvs[0]." AND ".$idPrvs[1];        else        {            if($idPrvs[0])            {                $proveedores .= " AND (";                for($i=0;$i<=count($idPrvs)-1;$i++)                {                    if($i>0)                        $proveedores .= " OR ";                    $proveedores .= " re.id_proveedor = ".$idPrvs[$i];                }                $proveedores .= ") ";            }           }        $almacenes='';        if(intval($vars['sucursal']))        {            $almacenes = "AND a.id_sucursal = ".$vars['sucursal'];            if(intval($vars['almacen']))                   $almacenes = "AND re.id_almacen = ".$vars['almacen'];        }        $usuario = '';        if(intval($vars['usuario']))            $usuario = "AND re.id_solicito = ".$vars['usuario'];        $caracteristicas = '';        if(intval($vars['tipo_producto']) == 1)        {            if(intval($vars['departamento']))                $caracteristicas .= " AND pr.id_departamento = ".$vars['departemento'];            if(intval($vars['familia']))                $caracteristicas .= " AND pr.id_familia = ".$vars['familia'];            if(intval($vars['linea']))                $caracteristicas .= " AND pr.id_linea = ".$vars['linea'];        }        if(intval($vars['tipo_producto']) == 2)        {            if(intval($vars['caracteristica_padre']))                $caracteristicas .= " AND rd.caracteristica LIKE '%".$vars['caracteristica_padre']."=>%'";            if(intval($vars['caracteristica_hija1']))            {                $caracteristicas .= " AND (";                for($k = $vars['caracteristica_hija1']; $k <= $vars['caracteristica_hija2']; $k++)                {                    if($k > intval($vars['caracteristica_hija1']))                        $caracteristicas .= " OR ";                    $caracteristicas .= " rd.caracteristica LIKE '%=>$k%' ";                }                $caracteristicas .= " ) ";            }        }        $unidad_base = '';        if(intval($vars['unidad_base']))            $unidad_base = "AND id_unidad_compra = ".$vars['unidad_base'];         $factor = "pr.id_unidad_compra";        if(intval($vars['unidad_base_conversion']))        {            $factor = $vars['unidad_base_conversion'];        }        $producto = '';        if(intval($vars['producto']))            $producto = " AND rd.id_producto = ".$vars['producto'];        if(intval($vars['status_doc']) == 1)            $vars['status_doc'] = "1 OR re.activo = 4 OR re.activo = 5";        if(intval($vars['status_doc']) == 0)            $vars['status_doc'] = "0 OR re.activo = 3";        $myQuery = "SELECT rd.caracteristica,re.id_proveedor,(SELECT razon_social FROM mrp_proveedor WHERE idPrv = re.id_proveedor) Proveedor,rd.id_producto,CONCAT('(',pr.codigo,') ',pr.nombre) AS Producto,re.fecha, re.id AS id_compra,rd.cantidad AS cantidad,(SELECT CONCAT(nombre,'*|*',factor) FROM app_unidades_medida WHERE id = $factor) AS UnidadBase,(SELECT costo FROM app_costos_proveedor WHERE id_producto = rd.id_producto AND id_proveedor = re.id_proveedor) AS costo,((SELECT costo FROM app_costos_proveedor WHERE id_producto = rd.id_producto AND id_proveedor = re.id_proveedor)*rd.cantidad) AS Importe, 0 AS impuestos FROM app_requisiciones_datos rd INNER JOIN app_requisiciones re ON re.id = rd.id_requisicionLEFT JOIN app_productos pr ON  pr.id = rd.id_productoLEFT JOIN app_almacenes a ON a.id = re.id_almacenWHERE re.fecha BETWEEN '".$vars['f_ini']."' AND '".$vars['f_fin']."' $producto $proveedores $almacenes $usuario $caracteristicas $unidad_base AND pr.id_moneda = ".$vars['moneda']." AND (re.activo = ".$vars['status_doc'].") ORDER BY re.id_proveedor, rd.id_producto, re.fecha";return $this->query($myQuery);    }    public function carac_padre()    {        $arr = Array();        $myQuery = "SELECT id,nombre FROM app_caracteristicas_padre";        $res = $this->query($myQuery);        while($r = $res->fetch_assoc())            $arr[$r['id']] = $r['nombre'];        return json_encode($arr);    }    public function carac_hija()    {        $arr = Array();        $myQuery = "SELECT id,nombre FROM app_caracteristicas_hija";        $res = $this->query($myQuery);        while($r = $res->fetch_assoc())            $arr[$r['id']] = $r['nombre'];        return json_encode($arr);    }}?>